---
description: Supabase Edge Functions 작성 시 표준 가이드 (모듈화, 주석, 구조화)
globs: supabase/functions/**/*.ts
alwaysApply: false
---

# Supabase Edge Functions 표준 가이드

Supabase Edge Functions를 작성하거나 수정할 때 유지보수성과 운영 효율성을 높이기 위해 다음 표준을 준수해야 합니다.

## 1. 헤더 주석 표준

모든 Edge Function 파일(`index.ts`) 최상단에는 파일의 의도와 이력을 명시하는 상세 헤더 주석을 포함해야 합니다.

```typescript
/**
 * =====================================================
 * ID: [기능ID (예: FN-V1-IMPORT-PLACE)]
 * 기능: [상세 기능 명칭]
 * 작성일: YYYY-MM-DD
 * 설명: [기능에 대한 상세 설명 및 비즈니스 로직 요약]
 * 
 * 관련 테이블:
 *   - [테이블명1]: [용도]
 *   - [테이블명2]: [용도]
 * 
 * 외부 의존성:
 *   - [외부 API명/링크]
 * 
 * 요청(Request Body):
 *   - [필드명]: [타입] ([설명])
 * 
 * 응답(Response):
 *   - 성공: { ok: true, data: ... }
 *   - 실패: { ok: false, message: "..." }
 * =====================================================
 */
```

## 2. 코드 구조화 및 모듈화

### 2.1 파일 구조
- `index.ts`: 메인 핸들러 및 흐름 제어
- 로직이 길어지는 경우 (200줄 이상), 관심사 별로 파일을 분리합니다.
  - `types.ts`: 인터페이스 및 타입 정의
  - `logic.ts` 또는 `utils.ts`: 비즈니스 로직 및 유틸리티 함수

### 2.2 공통 로직 모듈화
- 여러 함수에서 공용으로 사용하는 로직은 `supabase/functions/_shared/` 디렉토리에 위치시킵니다.
  - 예: `cors.ts`, `supabase-client.ts`, `error-handler.ts`

## 3. 표준 코드 패턴

### 3.1 요청 처리 및 보안
- CORS 대응을 위해 `OPTIONS` 메서드 처리를 최상단에 배치합니다.
- `Authorization` 헤더를 통한 사용자 인증 및 `supabase.auth.getUser()` 검증을 원칙으로 합니다.

### 3.2 에러 핸들링
- 모든 비즈니스 로직은 `try-catch` 블록으로 감싸 예기치 않은 서버 종료를 방지합니다.
- HTTP 상태 코드를 명확히 구분하여 반환합니다 (400: 유효성 실패, 401: 인증 실패, 403: 권한 없음, 500: 서버 에러).

### 3.3 응답 형식
- 일관된 JSON 응답 형식을 유지하기 위해 공통 유틸 함수 사용을 권장합니다.

```typescript
function jsonResponse(body: Record<string, unknown>, status = 200) {
  return new Response(JSON.stringify(body), {
    status,
    headers: {
      ...corsHeaders,
      "Content-Type": "application/json",
    },
  });
}
```

## 4. 유지보수 및 운영 고려사항

- **로깅**: 주요 단계마다 `console.log` 또는 `console.error`를 사용하여 실행 흐름을 추적할 수 있도록 합니다. (추후 Supabase Logs에서 확인 가능)
- **환경 변수**: API 키나 민감한 설정은 반드시 `Deno.env.get()`을 사용하고, 로컬 개발 시에는 `.env` 파일을 활용합니다.
- **주석**: 코드 내부의 복잡한 로직(Regex, 외부 API 파싱 등)에는 반드시 인라인 주석으로 동작 원리를 설명합니다.

## 5. 작성 체크리스트
- [ ] 헤더 주석에 작성일과 기능 설명이 상세히 기재되었는가?
- [ ] `TIMESTAMPTZ` 및 프로젝트 시간대 표준(KST)을 준수하는가?
- [ ] 유효성 검사에서 실패 시 명확한 에러 메시지를 반환하는가?
- [ ] 외부 API 호출 시 타임아웃 및 에러 처리가 고려되었는가?
