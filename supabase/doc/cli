# Supabase CLI 로컬 개발 가이드

이 문서는 Supabase 프로젝트를 로컬에서 설정하고, 에지 함수(Edge Functions)를 개발하며, 클라우드 환경과 동기화하는 과정을 설명합니다.

## 1. 초기 온보딩 (Onboarding)

프로젝트를 처음 시작하거나 로컬 환경을 설정할 때 다음 단계를 따릅니다.
### 설치 방법
```bash
brew install supabase/tap/supabase
```
### CLI 로그인
먼저 Supabase 계정으로 로그인합니다.
```bash
supabase login
```

### 프로젝트 초기화
프로젝트 루트 디렉토리에서 Supabase 설정을 초기화합니다. (이미 `config.toml`이 있다면 생략 가능)
```bash
supabase init
```

### 로컬 서비스 시작
Docker를 사용하여 Supabase 서비스(DB, Auth, Storage, API 등)를 로컬에서 실행합니다.
```bash
supabase start
```
실행이 완료되면 로컬 Studio 주소(`http://127.0.0.1:54323`)와 각종 API 키 정보가 표시됩니다.

---

## 2. 에지 함수(Edge Functions) 로컬 개발 및 테스트

### 새 함수 생성
새로운 에지 함수를 생성합니다.
```bash
supabase functions new <function-name>
```
이 명령은 `supabase/functions/<function-name>/index.ts` 파일을 생성합니다.

### 로컬에서 함수 실행
작성한 함수를 로컬 환경에서 실행하고 테스트합니다.
```bash
supabase functions serve
```
기본적으로 모든 함수는 `http://127.0.0.1:54321/functions/v1/<function-name>` 경로로 노출됩니다.

### 함수 테스트 (curl 예시)
`curl`을 사용하여 로컬에서 실행 중인 함수에 요청을 보낼 수 있습니다.
```bash
curl -i --location --request POST 'http://127.0.0.1:54321/functions/v1/<function-name>' \
  --header 'Authorization: Bearer <anon-key>' \
  --header 'Content-Type: application/json' \
  --data '{ "name":"Supabase" }'
```
*참고: `<anon-key>`는 `supabase start` 실행 시 출력된 `anon key`를 사용합니다.*

---

## 3. 클라우드 동기화 및 배포

로컬에서 개발한 내용을 실제 Supabase 클라우드 프로젝트에 적용합니다.

### 클라우드 프로젝트 연결
로컬 프로젝트를 특정 클라우드 프로젝트와 연결합니다. (Project Ref는 프로젝트 설정에서 확인 가능)
```bash
supabase link --project-ref <project-id>
```

### 데이터베이스 스키마 동기화
로컬에서 변경한 마이그레이션 내역을 클라우드 DB에 적용합니다.
```bash
supabase db push
```

### 에지 함수 배포
작성한 에지 함수를 클라우드에 배포합니다.
```bash
supabase functions deploy <function-name>
```

### 클라우드에서 함수 가져오기 (동기화)
클라우드에 이미 존재하는 함수를 로컬로 다운로드합니다.

#### 개별 함수 다운로드
```bash
supabase functions download <function-name>
```
이 명령을 실행하면 `supabase/functions/<function-name>` 디렉토리에 클라우드의 소스코드가 저장됩니다.

#### 모든 함수 한 번에 다운로드
CLI 자체적으로는 전체 다운로드 명령어를 제공하지 않지만, `jq`를 사용하여 다음과 같이 실행할 수 있습니다.
```bash
supabase functions list -o json | jq -r '.[].name' | xargs -I {} supabase functions download {}
```

> [!WARNING]
> **주의사항 (Download 시)**
> 1. **로컬 파일 덮어쓰기**: `download` 명령어는 로컬에 동일한 이름의 폴더가 있을 경우 경고 없이 파일을 덮어씁니다. 로컬에서 작업 중인 내용이 있다면 미리 백업하거나 Git으로 커밋해두세요.
> 2. **환경 변수(.env)**: `download`는 소스 코드만 가져오며, `secret` 설정값은 가져오지 않습니다. 환경 변수는 별도로 설정해야 합니다.

---

## 4. 데이터베이스 구조 및 큐(Queue) 처리

### 장소 수집 큐 (`tbl_place_queue`)
에지 함수(`graph-search-place`)는 검색 결과를 반환할 때, `tbl_place` 테이블에 없는 신규 장소를 자동으로 이 테이블에 추가합니다.

- **상태값(`status`)**:
    - `PENDING`: 대기 중
    - `PROCESSING`: 처리 중
    - `SUCCESS`: 성공
    - `FAILED`: 실패
    - `STOPPED`: 중지 (재시도 횟수 초과 등)
- **자동 처리**: `created_at`, `updated_at` 컬럼과 재시도 제한(`retry_limit`, 기본 5회)이 설정되어 있습니다.

### 마이그레이션 적용
새로운 테이블 설정을 로컬 DB에 적용하려면 다음 명령을 실행합니다.
```bash
supabase db reset
```
*(주의: `db reset`은 로컬 DB를 초기화하고 모든 마이그레이션을 재적용합니다.)*

---

## 5. 장소 상세 크롤러 (`fn_v1_crw_for_place_queue`)

`tbl_place_queue`에 쌓인 장소 ID를 바탕으로 네이버에서 상세 정보를 수집하는 자동 크롤러 함수입니다.

### 크롤링 로그 테이블 (`tbl_crw_log`)
모든 크롤링 작업의 결과는 이 테이블에 기록됩니다.
- **주요 컬럼**:
    - `place_id`: 대상 장소 식별자
    - `status`: SUCCESS / FAILED
    - `duration_ms`: 작업 소요 시간
    - `error_message`: 실패 시 상세 원인

### 크롤러 실행 (로컬 테스트)
```bash
supabase functions serve fn_v1_crw_for_place_queue
```
이후 아래와 같이 빈 POST 요청을 보내면 큐에 있는 항목 하나를 처리합니다.
```bash
curl -i --location --request POST 'http://127.0.0.1:54321/functions/v1/fn_v1_crw_for_place_queue' \
  --header 'Authorization: Bearer <service-role-key>'
```

#### Service Role Key 확인 방법
로컬 환경에서 관리자 권한(`service_role`) 키를 확인하려면 터미널에서 다음 명령어를 실행합니다.
```bash
supabase status
```
출력 결과의 **`🔑 Authentication Keys`** 섹션에서 **`Secret`** 항목의 값이 바로 `service-role-key`입니다.

### 크롤러 설계 원칙
1. **멱등성**: 이미 처리된 장소는 `tbl_place`에서 `upsert` 처리되어 중복 데이터 생성을 방지합니다.
2. **안정성**: `PENDING` -> `PROCESSING` -> `SUCCESS/FAILED` 상태 전이를 통해 중복 처리를 방지하고, 실패 시 `retry_limit`(5회)까지 재시도합니다.
3. **추적성**: `tbl_crw_log`를 통해 각 장소별 크롤링 성공 여부와 소요 시간을 모니터링할 수 있습니다.

---

curl -sS -X POST \
  "https://xyqpggpilgcdsawuvpzn.functions.supabase.co/fn_v1_import_place_to_folder" \
  -H "Authorization: Bearer 850181e4652dd023b7a98c58ae0d2d34bd487ee0cc3254aed6eda37307425907" \
  -H "Content-Type: application/json" \
  -d '{"folderId":"557356db-ea3e-4ff4-8d3d-569a7a1d8092","input":"0043c558326349539c3d46b21da66fd3"}'

## 6. ⚠️ 주요 주의사항

1.  **데이터베이스 초기화 (`db reset`)**: 
    - 로컬 DB의 **모든 데이터가 삭제**되고 처음부터 마이그레이션이 실행됩니다. 중요한 테스트 데이터가 있다면 `supabase/seed.sql`에 저장해 두세요.
2.  **클라우드 배포 (`functions deploy`)**:
    - 로컬 코드가 클라우드의 기존 코드를 즉시 대체합니다. 배포 전 `supabase functions serve`로 충분히 테스트했는지 확인하세요.
3.  **환경 변수 관리**:
    - `.env` 파일은 절대 Git에 커밋하지 마세요. 클라우드 설정은 `supabase secrets set` 명령어를 사용합니다.
4.  **Service Role Key 보안**:
    - `service_role` 키는 모든 보안 정책(RLS)을 우회합니다. 절대 클라이언트 사이드(브라우저) 코드에서 사용하거나 외부에 노출하지 마세요.

---

## 기타 유용한 명령어
- `supabase status`: 현재 로컬 서비스 상태 확인
- `supabase stop`: 로컬 서비스 중지
- `supabase db reset`: 로컬 데이터베이스 초기화 (마이그레이션 및 시드 데이터 재적용)
