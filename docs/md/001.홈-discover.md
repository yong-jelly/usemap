# 홈 화면 Discover 기능 개선 계획

## 현재 상태 (2026-01-27)

### 완료된 작업
- [x] `v2_get_popular_places` RPC 함수 생성 - 개별 음식점 단위 인기 점수 계산
- [x] `get-home-discover` Edge Function에서 `popularPlaces` 반환
- [x] `HomePage.tsx`에서 인기 음식점 섹션 표시
- [x] 프론트엔드 타입 정의 (`PopularPlace` 인터페이스)

### 미완료 작업 (DB 성능 문제로 중단.)
## 중단 원인

### DB 성능 문제
1. **복합 집계 쿼리 타임아웃**: `tbl_naver_folder_place`, `tbl_place_features`, `tbl_folder_place` 3개 테이블의 UNION ALL 후 집계하는 쿼리가 3분 이상 소요
2. **서브쿼리 중첩**: 각 음식점별 이미지, 테마, 리뷰 수 등을 조회하는 서브쿼리가 600개 이상의 행에 대해 실행되어 성능 저하
3. **Supabase Pooler 연결 제한**: 장시간 쿼리로 인한 연결 타임아웃 발생

### 해결 방안 (추후 적용)
1. **인덱스 최적화**: `place_id` 기준 복합 인덱스 추가
2. **Materialized View 사용**: 인기 점수를 미리 계산해두는 뷰 생성
3. **배치 처리**: 대량 데이터 삽입 시 청크 단위로 나눠서 처리
4. **pg_cron 활용**: 오프피크 시간에 캐시 갱신

---

## 구현 예정 기능

### 1. 캐시 테이블 설계: `tbl_cache_popular_place`

```sql
CREATE TABLE tbl_cache_popular_place (
  id SERIAL PRIMARY KEY,
  
  -- 콘텐츠 식별
  content_type TEXT NOT NULL,  -- 'place', 'folder', 'naver_folder', 'youtube_channel', 'category', 'region', 'theme'
  content_id TEXT NOT NULL,    -- 해당 타입의 고유 ID
  
  -- 표시 정보
  title TEXT NOT NULL,         -- 표시명
  subtitle TEXT,               -- 부제목 (카테고리명, 지역명 등)
  thumbnail TEXT,              -- 대표 이미지 URL
  
  -- 필터링/집계용 컬럼 (place 기준, 다른 타입은 NULL 가능)
  category TEXT,               -- 음식 카테고리
  group1 TEXT,                 -- 지역 (시/도)
  group2 TEXT,                 -- 지역 (구/군)
  themes TEXT[],               -- 테마 키워드 배열 (votedKeyword에서 추출)
  review_count INTEGER,        -- 리뷰 수
  review_count_range TEXT,     -- 리뷰 범주: 'under_10', '10_50', '50_100', '100_plus'
  
  -- 정렬/랭킹
  popularity_score INTEGER DEFAULT 0,  -- 인기 점수
  place_count INTEGER,                  -- 폴더/채널의 장소 수
  random_seed INTEGER,                  -- 랜덤 정렬용 (0-999)
  
  -- 메타데이터
  metadata JSONB,              -- 추가 정보 (preview_places 등)
  batch_id TEXT,               -- 배치 식별자 (갱신 시 사용)
  created_at TIMESTAMPTZ DEFAULT now(),
  
  UNIQUE(content_type, content_id)
);

-- 인덱스
CREATE INDEX idx_cache_popular_type ON tbl_cache_popular_place(content_type);
CREATE INDEX idx_cache_popular_category ON tbl_cache_popular_place(category) WHERE category IS NOT NULL;
CREATE INDEX idx_cache_popular_group1 ON tbl_cache_popular_place(group1) WHERE group1 IS NOT NULL;
CREATE INDEX idx_cache_popular_themes ON tbl_cache_popular_place USING GIN(themes) WHERE themes IS NOT NULL;
CREATE INDEX idx_cache_popular_review_range ON tbl_cache_popular_place(review_count_range);
CREATE INDEX idx_cache_popular_random ON tbl_cache_popular_place(random_seed);
```

### 2. 콘텐츠 타입별 데이터 구조

| content_type | content_id | title | 주요 용도 |
|--------------|-----------|-------|---------|
| `place` | place_id | 음식점명 | 인기 음식점 |
| `folder` | folder_id | 폴더 제목 | 맛탐정 사용자 폴더 |
| `naver_folder` | folder_id | 폴더명 | 네이버 맛집 폴더 |
| `youtube_channel` | channel_id | 채널명 | 유튜브 맛집 채널 |
| `category` | category명 | 카테고리명 | "냉면", "칼국수" 등 |
| `region` | group1_group2 | 지역명 | "서울 강남구" 등 |
| `theme` | theme_code | 테마명 | "혼밥", "데이트" 등 |

### 3. 인기 점수 계산 로직

```sql
-- 인기 점수 = 네이버폴더 등장횟수 + 유튜브채널 등장횟수 + 맛탐정폴더 등장횟수
WITH place_counts AS (
    SELECT place_id, count(*) as cnt FROM tbl_naver_folder_place GROUP BY place_id
    UNION ALL
    SELECT place_id, count(*) as cnt FROM tbl_place_features GROUP BY place_id
    UNION ALL
    SELECT place_id, count(*) as cnt FROM tbl_folder_place GROUP BY place_id
),
aggregated_counts AS (
    SELECT place_id, SUM(cnt) as popularity_score
    FROM place_counts
    GROUP BY place_id
)
SELECT * FROM aggregated_counts ORDER BY popularity_score DESC;
```

### 4. 캐시 갱신 함수 (성능 최적화 필요)

```sql
CREATE OR REPLACE FUNCTION public.v2_refresh_popular_place_cache()
RETURNS TABLE(inserted_count INTEGER, deleted_count INTEGER)
LANGUAGE plpgsql
AS $$
-- 1시간마다 실행 (pg_cron)
-- 인기 음식점 600개, 네이버폴더 100개, 유튜브채널 100개, 
-- 맛탐정폴더 100개, 카테고리 50개, 지역 50개를 캐시
$$;
```

### 5. 피드 조회 함수

```sql
CREATE OR REPLACE FUNCTION public.v2_get_popular_feed(
    p_limit INTEGER DEFAULT 20,
    p_offset INTEGER DEFAULT 0,
    p_content_types TEXT[] DEFAULT NULL,  -- 필터: ['place', 'folder'] 등
    p_category TEXT DEFAULT NULL,          -- 필터: 카테고리
    p_region TEXT DEFAULT NULL,            -- 필터: 지역 (group1)
    p_theme TEXT DEFAULT NULL              -- 필터: 테마
)
RETURNS TABLE(
    id INTEGER,
    content_type TEXT,
    content_id TEXT,
    title TEXT,
    subtitle TEXT,
    thumbnail TEXT,
    category TEXT,
    group1 TEXT,
    group2 TEXT,
    popularity_score INTEGER,
    place_count INTEGER,
    metadata JSONB
)
LANGUAGE plpgsql;
```

---

## 프론트엔드 구현 계획

### 1. 타입 정의 추가 (`src/entities/home/types.ts`)

```typescript
export interface CachePopularItem {
  id: number;
  content_type: 'place' | 'folder' | 'naver_folder' | 'youtube_channel' | 'category' | 'region' | 'theme';
  content_id: string;
  title: string;
  subtitle?: string;
  thumbnail?: string;
  category?: string;
  group1?: string;
  group2?: string;
  popularity_score?: number;
  place_count?: number;
  metadata?: Record<string, any>;
}
```

### 2. API 함수 추가 (`src/entities/home/api.ts`)

```typescript
getPopularFeed: async (params: {
  limit?: number;
  offset?: number;
  contentTypes?: string[];
  category?: string;
  region?: string;
  theme?: string;
}) => {
  // v2_get_popular_feed RPC 호출
}
```

### 3. 무한 스크롤 훅 (`src/entities/home/queries.ts`)

```typescript
export function usePopularFeed(filters?: PopularFeedFilters) {
  return useInfiniteQuery({
    queryKey: ['popularFeed', filters],
    queryFn: ({ pageParam = 0 }) => homeApi.getPopularFeed({
      offset: pageParam,
      limit: 20,
      ...filters
    }),
    getNextPageParam: (lastPage, pages) => {
      if (lastPage.length < 20) return undefined;
      return pages.length * 20;
    },
  });
}
```

### 4. HomePage 무한 스크롤 UI

```typescript
// IntersectionObserver를 사용한 무한 스크롤
const { ref, inView } = useInView();

useEffect(() => {
  if (inView && hasNextPage) {
    fetchNextPage();
  }
}, [inView, hasNextPage, fetchNextPage]);
```

### 5. 카드 컴포넌트별 UI

| 타입 | UI 컴포넌트 | 특징 |
|-----|-----------|-----|
| `place` | PopularPlaceCard | 음식점 이미지, 이름, 카테고리, 인기점수 |
| `folder` | CollectionCard | 4분할 이미지, 폴더명, 장소 수 |
| `naver_folder` | CollectionCard (녹색 배지) | 네이버 아이콘, 폴더명 |
| `youtube_channel` | CollectionCard (빨간 배지) | 유튜브 아이콘, 채널명 |
| `category` | CategoryCard | 대표 이미지, 카테고리명, 장소 수 |
| `region` | RegionCard | 지역 대표 이미지, 지역명 |
| `theme` | ThemeCard | 테마 아이콘, 테마명, 장소 수 |

---

## 체크리스트

### DB 작업
- [ ] 인덱스 최적화 검토 (place_id 기준 복합 인덱스)
- [ ] `tbl_cache_popular_place` 테이블 생성
- [ ] `v2_refresh_popular_place_cache()` 함수 생성 (성능 최적화 버전)
- [ ] `v2_get_popular_feed()` 함수 생성
- [ ] pg_cron으로 1시간마다 캐시 갱신 스케줄 설정

### 프론트엔드 작업
- [ ] `CachePopularItem` 타입 정의
- [ ] `getPopularFeed` API 함수 추가
- [ ] `usePopularFeed` 무한 스크롤 훅 추가
- [ ] `HomePage.tsx`에 무한 스크롤 로직 구현
- [ ] `CategoryCard`, `RegionCard`, `ThemeCard` 컴포넌트 추가

### 테스트
- [ ] 캐시 갱신 함수 성능 테스트 (목표: 30초 이내)
- [ ] 무한 스크롤 UX 테스트
- [ ] 필터링 기능 테스트

---

## 관련 파일

- `docs/sql/089_create_cache_popular_place.sql` - 테이블 생성 SQL (미적용)
- `docs/sql/090_create_v2_refresh_popular_place_cache.sql` - 캐시 갱신 함수 SQL (미적용)
- `supabase/functions/get-home-discover/index.ts` - Edge Function (완료)
- `src/entities/home/types.ts` - 타입 정의
- `src/entities/home/api.ts` - API 함수
- `src/entities/home/queries.ts` - React Query 훅
- `src/pages/HomePage.tsx` - 홈 화면 UI
