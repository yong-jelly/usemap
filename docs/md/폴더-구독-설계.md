# 맛탐정(폴더) 및 구독 시스템 설계서

본 문서는 사용자가 직접 장소를 큐레이션하고 관리하는 '맛탐정' 폴더 시스템과, 다양한 피쳐를 팔로우하는 구독 시스템의 기술적 설계 및 구현 상세를 다룹니다.

---

## 1. 개요
'맛탐정'은 사용자가 자신만의 맛집 리스트를 폴더 형태로 관리하고 공유하는 기능입니다. 플레이리스트와 유사한 개념으로, 장소를 추가/삭제하고 다른 사용자의 폴더를 구독하여 피드 형식으로 새 소식을 받아볼 수 있습니다.

---

## 2. 폴더 시스템 (Folder System)

### 2.1 권한 및 접근 제어 (Permissions)
폴더 생성 시 다음 5가지 권한 중 하나를 선택할 수 있으며, 생성 후 공개/비공개 상태 변경은 불가능합니다.

| 권한 유형 | UI 라벨 | 설명 | 접근 제어 (SQL) | 노출 범위 |
|:---|:---|:---|:---|:---|
| **공개 (Public)** | 공개 | 모든 사용자가 조회 가능 | 누구나 조회 가능, 소유자만 편집 | 목록 검색 및 피쳐 페이지 노출 |
| **비공개 (링크) (Private)** | 비공개 (링크) | 링크를 통해서만 접근 가능 | URL 접속 허용, 소유자만 편집 | 목록 미노출 (Unlisted) |
| **비공개 (전용) (Hidden)** | 비공개 (전용) | 나만 볼 수 있는 폴더 | 소유자만 접근 가능 | 목록/검색 전체 제외 (404 처리) |
| **비공개 (초대) (Invite)** | 비공개 (초대 전용) | 초대 코드가 필요한 폴더 | 코드 입력 시 구독/조회 가능 | 목록 미노출, 설정에 따라 공동 편집 가능 |
| **기본 (Default)** | - | 시스템 자동 생성 폴더 | 소유자 전용 가상 폴더 | 수정/삭제 불가, 본인 프로필 전용 |

> **주의**: UI 코드상의 ID(`private`, `hidden`)와 SQL의 접근 제어 로직이 매칭되어 있습니다. `private`은 링크 접근 허용(Unlisted), `hidden`은 완전 비공개(Owner Only)를 의미합니다.

### 2.2 핵심 기능
- **폴더 생성**: 제목(20자), 설명(50자) 제한. `permission_write_type` 설정을 통해 편집 권한 제어 가능.
    - `0`: 소유자만 편집 (기본값)
    - `1`: 참여자와 함께 편집 (초대 폴더에서 유효)
- **장소 관리**: `v1_add_place_to_folder`를 통한 장소 추가. 공동 편집 허용 시 구독자도 추가 가능.
    - 본인이 추가한 장소는 본인이 삭제 가능.
    - 소유자는 폴더 내 모든 장소 삭제 가능.
- **폴더 관리**: 삭제 대신 `v1_hide_folder`를 통한 '숨김(is_hidden)' 처리로 데이터 보존 및 구독자 접근 차단.
- **편집 권한**: `v1_update_folder`를 통해 제목, 설명 및 공동 편집 설정을 추후 변경 가능.
- **비공개 리뷰**: 초대 폴더 내에서 `v1_upsert_folder_review`를 통해 멤버 전용 리뷰 작성 가능. 평점은 소수점 1자리까지 지원.

### 2.3 초대 시스템 (Invite System)
- **초대 코드**: 영문/숫자 혼합 5자리 무작위 생성.
- **유효 기간**: 생성 시점으로부터 **24시간** 동안만 유효.
- **재생성**: 소유자는 만료된 코드를 언제든 재생성 가능 (기존 코드는 즉시 만료).
- **히스토리**: 소유자는 누가, 언제 코드를 사용하여 구독했는지 관리 모달에서 확인 가능.

### 2.4 비공개 리뷰 (Private Review)
- **대상**: 오직 **초대(Invite)** 폴더 내에서만 동작.
- **기능**: 폴더 멤버들끼리만 공유되는 프라이빗한 리뷰 작성.
- **정책**: 이 리뷰는 전체 통계(평점, 카운트)나 공용 피드에 노출되지 않으며 폴더 내부에서만 유효함.

---

## 3. 구독 및 피드 시스템

### 3.1 구독 서비스
- **대상**: 맛탐정 폴더, 네이버 플레이스 폴더, 유튜브 채널, 커뮤니티 지역.
- **관리**: 사용자의 `/profile` 페이지 '구독' 탭에서 통합 관리.
- **카운팅**: 실시간 구독자 수 집계 및 피쳐 페이지 노출.

### 3.2 피드 (Feed)
- **로직**: 내가 구독 중인 모든 소스(폴더, 채널 등)에서 새롭게 추가된 장소를 최신순으로 정렬.
- **UI**: 현대적인 SNS 스타일의 카드 UI로 주소, 카테고리, 추가일자 등 표시.
- **자동 포함**: 내가 직접 소유한 폴더의 새 소식도 피드에 포함됨.

---

## 4. 데이터베이스 설계 (PostgreSQL)

### 4.1 주요 테이블
- `tbl_folder`: 폴더 기본 정보 및 권한 설정 (`permission_write_type` 포함).
- `tbl_folder_place`: 폴더와 장소의 M:N 관계. `user_id`를 기록하여 누가 추가했는지 관리하며, 소프트 삭제(`deleted_at`) 지원.
- `tbl_folder_subscribed`: 폴더 구독 정보. 초대 코드를 통한 구독 시 `activation` 상태 관리.
- `tbl_feature_subscription`: 시스템 피쳐(네이버 폴더, 유튜브 채널 등) 구독 정보.
- `tbl_folder_invite_history`: 초대 코드 생성 및 사용(`accepted`) 이력 관리.
- `tbl_folder_review`: 초대 폴더 멤버 전용 비공개 리뷰 및 평점.

### 4.2 핵심 RPC 함수
- `v1_check_folder_access(folder_id)`: 사용자의 조회(`can_view`) 및 편집(`can_edit`) 권한을 권한 유형별로 종합 판정.
- `v1_verify_invite_code(folder_id, code)`: 초대 코드의 유효성(만료 여부 등)을 검증하고 성공 시 자동 구독 및 히스토리 업데이트.
- `v1_add_place_to_folder(folder_id, place_id)`: 권한 정책(`owner` 또는 `collaborator`)에 따른 장소 추가 로직 수행.
- `v1_update_folder(...)`: 폴더의 기본 정보 및 편집 권한 설정을 동적으로 업데이트.
- `v1_get_my_feed(limit, offset)`: 구독 중인 다양한 소스의 새 장소 데이터를 Union 및 Join하여 통합 피드 생성.

---

## 5. 흐름도 (Flowcharts)

### 5.1 폴더 생성 및 초대 흐름
```text
[소유자]                     [시스템]                     [초대받은 사용자]
   |                           |                               |
   |-- 1. 폴더 생성(Invite) -->|                               |
   |                           |-- 2. 5자리 코드 생성(24h) ---->|
   |<-- 3. 코드/성공 모달 노출 --|                               |
   |                           |                               |
   |--- 4. 외부 채널로 공유 ------------------------------------>|
   |                           |                               |
   |                           |       5. 링크 접속 (ID전달) ----|
   |                           |<-- 6. v1_check_folder_access -|
   |                           |-- 7. INVITE_CODE_REQUIRED --->|
   |                           |                               |
   |                           |       8. 코드 입력/제출 --------|
   |                           |<-- 9. v1_verify_invite_code --|
   |                           |-- 10. 검증성공/자동구독 --------|
   |                           |                               |
   |                           |       11. 폴더 상세 진입 -------|
```

### 5.2 피드 생성 흐름
```text
[사용자]                     [DB / RPC]                   [데이터 소스]
   |                           |                               |
   |--- 1. 피드 페이지 접속 --->|                               |
   |                           |-- 2. 내 구독 목록 추출 -------->| (tbl_folder_subscribed)
   |                           |                               | (tbl_feature_subscription)
   |                           |                               |
   |                           |-- 3. 소스별 신규 장소 취합 ---->| (tbl_folder_place)
   |                           |      (UNION ALL)              | (tbl_place_features)
   |                           |                               |
   |                           |-- 4. 장소 상세 정보 Join ------>| (tbl_place)
   |                           |                               |
   |<-- 5. 최신순 정렬 리스트 --|                               |
```

---

## 6. 보안 및 최적화
- **RLS (Row Level Security)**: 기본적으로 모든 테이블에 적용되어 타인의 비공개 데이터 접근 차단.
- **Index 최적화**: `(folder_id, deleted_at)`, `(user_id, feature_id)` 등 빈번한 Join 및 필터링 컬럼에 인덱스 구성.
- **모바일 최적화**: 피드 스크롤 시 `will-change: scroll-position` 및 이미지 Lazy Loading 적용.
