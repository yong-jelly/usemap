# 맛탐정(폴더) 및 구독 시스템 설계서

본 문서는 사용자가 직접 장소를 큐레이션하고 관리하는 '맛탐정' 폴더 시스템과, 다양한 피쳐를 팔로우하는 구독 시스템의 기술적 설계 및 구현 상세를 다룹니다.

---

## 1. 개요
'맛탐정'은 사용자가 자신만의 맛집 리스트를 폴더 형태로 관리하고 공유하는 기능입니다. 플레이리스트와 유사한 개념으로, 장소를 추가/삭제하고 다른 사용자의 폴더를 구독하여 피드 형식으로 새 소식을 받아볼 수 있습니다.

---

## 2. 폴더 시스템 (Folder System)

### 2.1 권한 및 접근 제어 (Permissions)
폴더 생성 시 다음 5가지 권한 중 하나를 선택할 수 있으며, 생성 후 공개/비공개 상태 변경은 불가능합니다.

| 권한 유형 | 설명 | 접근 제어 | 노출 범위 |
|:---|:---|:---|:---|
| **공개 (Public)** | 모든 사용자가 조회 가능 | 누구나 조회 가능, 소유자만 편집 | 목록 검색 및 피쳐 페이지 노출 |
| **비공개 (Private)** | 링크를 통해서만 접근 가능 | URL 접속 허용, 소유자만 편집 | 목록 미노출 (Unlisted) |
| **숨김 (Hidden)** | 나만 볼 수 있는 폴더 | 소유자만 접근 가능 | 목록/검색 전체 제외 (404 처리) |
| **초대 (Invite)** | 초대 코드가 필요한 폴더 | 코드 입력 시 구독/조회 가능 | 목록 미노출, 구독자 공동 편집 가능 |
| **기본 (Default)** | 시스템 자동 생성 폴더 | 소유자 전용 가상 폴더 | 수정/삭제 불가, 본인 프로필 전용 |

### 2.2 핵심 기능
- **폴더 생성**: 제목(20자), 설명(50자) 제한. 초대 폴더의 경우 '공동 편집 여부' 설정 가능.
- **장소 관리**: `graph-search-place`를 통한 장소 검색 및 폴더 추가.
- **폴더 관리**: 삭제 대신 '숨김(is_hidden)' 처리로 데이터 보존 및 구독자 접근 차단.
- **공동 편집**: 초대 폴더 설정에 따라 구독자가 직접 장소를 추가하거나 본인이 추가한 장소를 삭제할 수 있음.

### 2.3 초대 시스템 (Invite System)
- **초대 코드**: 영문/숫자 혼합 5자리 무작위 생성.
- **유효 기간**: 생성 시점으로부터 **24시간** 동안만 유효.
- **재생성**: 소유자는 만료된 코드를 언제든 재생성 가능 (기존 코드는 즉시 만료).
- **히스토리**: 소유자는 누가, 언제 코드를 사용하여 구독했는지 관리 모달에서 확인 가능.

### 2.4 비공개 리뷰 (Private Review)
- **대상**: 오직 **초대(Invite)** 폴더 내에서만 동작.
- **기능**: 폴더 멤버들끼리만 공유되는 프라이빗한 리뷰 작성.
- **정책**: 이 리뷰는 전체 통계(평점, 카운트)나 공용 피드에 노출되지 않으며 폴더 내부에서만 유효함.

---

## 3. 구독 및 피드 시스템

### 3.1 구독 서비스
- **대상**: 맛탐정 폴더, 네이버 플레이스 폴더, 유튜브 채널, 커뮤니티 지역.
- **관리**: 사용자의 `/profile` 페이지 '구독' 탭에서 통합 관리.
- **카운팅**: 실시간 구독자 수 집계 및 피쳐 페이지 노출.

### 3.2 피드 (Feed)
- **로직**: 내가 구독 중인 모든 소스(폴더, 채널 등)에서 새롭게 추가된 장소를 최신순으로 정렬.
- **UI**: 현대적인 SNS 스타일의 카드 UI로 주소, 카테고리, 추가일자 등 표시.
- **자동 포함**: 내가 직접 소유한 폴더의 새 소식도 피드에 포함됨.

---

## 4. 데이터베이스 설계 (PostgreSQL)

### 4.1 주요 테이블
- `tbl_folder`: 폴더 기본 정보 및 권한 설정.
- `tbl_folder_place`: 폴더와 장소의 M:N 관계 및 등록자 정보.
- `tbl_folder_subscribed`: 폴더 구독 정보 (소프트 삭제 지원).
- `tbl_feature_subscription`: 시스템 피쳐(유튜브 등) 구독 정보.
- `tbl_folder_invite_history`: 초대 코드 생성 및 수락 이력.
- `tbl_folder_review`: 폴더 전용 비공개 리뷰.

### 4.2 핵심 RPC 함수
- `v1_check_folder_access(folder_id)`: 현재 사용자의 폴더 접근 권한(조회/편집 가능 여부)을 종합 판정.
- `v1_verify_invite_code(folder_id, code)`: 코드 일치 여부 및 시간 만료 체크 후 자동 구독 처리.
- `v1_get_my_feed(limit, offset)`: 구독 소스별 Join 및 Union을 통한 통합 피드 생성.

---

## 5. 흐름도 (Flowcharts)

### 5.1 폴더 생성 및 초대 흐름
```text
[소유자]                     [시스템]                     [초대받은 사용자]
   |                           |                               |
   |-- 1. 폴더 생성(Invite) -->|                               |
   |                           |-- 2. 5자리 코드 생성(24h) ---->|
   |<-- 3. 코드/성공 모달 노출 --|                               |
   |                           |                               |
   |--- 4. 외부 채널로 공유 ------------------------------------>|
   |                           |                               |
   |                           |       5. 링크 접속 (ID전달) ----|
   |                           |<-- 6. v1_check_folder_access -|
   |                           |-- 7. INVITE_CODE_REQUIRED --->|
   |                           |                               |
   |                           |       8. 코드 입력/제출 --------|
   |                           |<-- 9. v1_verify_invite_code --|
   |                           |-- 10. 검증성공/자동구독 --------|
   |                           |                               |
   |                           |       11. 폴더 상세 진입 -------|
```

### 5.2 피드 생성 흐름
```text
[사용자]                     [DB / RPC]                   [데이터 소스]
   |                           |                               |
   |--- 1. 피드 페이지 접속 --->|                               |
   |                           |-- 2. 내 구독 목록 추출 -------->| (tbl_folder_subscribed)
   |                           |                               | (tbl_feature_subscription)
   |                           |                               |
   |                           |-- 3. 소스별 신규 장소 취합 ---->| (tbl_folder_place)
   |                           |      (UNION ALL)              | (tbl_place_features)
   |                           |                               |
   |                           |-- 4. 장소 상세 정보 Join ------>| (tbl_place)
   |                           |                               |
   |<-- 5. 최신순 정렬 리스트 --|                               |
```

---

## 6. 보안 및 최적화
- **RLS (Row Level Security)**: 기본적으로 모든 테이블에 적용되어 타인의 비공개 데이터 접근 차단.
- **Index 최적화**: `(folder_id, deleted_at)`, `(user_id, feature_id)` 등 빈번한 Join 및 필터링 컬럼에 인덱스 구성.
- **모바일 최적화**: 피드 스크롤 시 `will-change: scroll-position` 및 이미지 Lazy Loading 적용.
