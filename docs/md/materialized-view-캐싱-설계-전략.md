# Materialized View 캐싱 설계 전략

## 1. 개요
데이터 양이 많거나 복잡한 Join이 포함된 조회 쿼리의 성능을 최적화하기 위해 PostgreSQL의 Materialized View(MV)를 활용한 캐싱 레이어를 구축합니다. 특히 실시간성이 아주 엄격하지 않은 피드나 통계성 데이터에 적용합니다.

## 2. 적용 대상 및 기준
- **복잡한 집계**: 여러 테이블의 Union 및 JOIN이 발생하는 쿼리.
- **빈번한 조회**: 메인 화면 피드, 지역별 탐색 등 사용자가 자주 접속하는 화면.
- **허용 가능한 지연**: 데이터 갱신 주기가 1~3시간 정도여도 사용자 경험에 큰 지장이 없는 경우.

## 3. 구현 방식

### 3.1 Materialized View 생성
- 데이터 원천(Source)을 통합하여 하나의 뷰로 정의합니다.
- `CONCURRENTLY` 갱신을 위해 유니크 인덱스를 필수로 생성합니다.

### 3.2 자동 갱신 (Supabase pg_cron)
- `pg_cron` 익스텐션을 사용하여 주기적으로 `REFRESH MATERIALIZED VIEW CONCURRENTLY`를 실행합니다.
- 갱신 주기는 트래픽과 데이터 변경 빈도에 따라 1시간~3시간으로 설정합니다.

## 4. 개별 캐싱 전략 현황

### 4.1 지역별 통합 컨텐츠 (`mv_region_contents`)
- **목적**: 지역별로 분산된 다양한 소스(커뮤니티, 유튜브, 폴더 등)의 데이터를 통합 조회.
- **갱신 주기**: 3시간 (`0 */3 * * *`)
- **주요 필드**: 소스 구분, 지역명, 장소 수, 미리보기 데이터(JSONB).

### 4.2 공개 피드 (`mv_public_feed`)
- **목적**: `v1_get_public_feed` 함수의 타임아웃 해결 및 조회 성능 개선.
- **갱신 주기**: 1시간 (`0 * * * *`)
- **주요 필드**: `source_type`, `source_id`, `source_title`, `source_image`, `place_id`, `place_data`, `added_at`.
- **특이사항**: `tbl_place` 데이터를 미리 JSONB로 가공하여 저장함으로써 조회 시 연산 부하를 최소화함.

## 5. 관리 및 주의사항
- **인덱스 관리**: MV 조회 성능을 위해 필터링 조건(예: `source_type`)에 맞는 인덱스를 생성합니다.
- **갱신 실패 모니터링**: `pg_cron` 로그를 통해 갱신 성공 여부를 주기적으로 확인합니다.
- **실시간성 보완**: 즉각적인 반영이 필요한 기능은 MV가 아닌 실시간 쿼리 또는 Hybrid 방식을 검토합니다.
