public.tbl_bucket (
  key character varying(255) not null,
  name character varying(255) not null,
  value character varying(1000) null,
  data character varying(5000) null,
  data_jsonb jsonb null,
  created_at timestamp without time zone null default now(),
  updated_at timestamp without time zone null default now(),
  constraint pk_tbl_bucket primary key (key, name)
)
select
  data_jsonb as bucket
from
  tbl_bucket
where
  key = 'naver_folder_list'
  and name = 'naver_folder_list';

delete from
  tbl_bucket
where
  key = 'naver_folder_list'
  and name = 'naver_folder_list';

-- [2025/07/24]
-- 폴더별 장소 개수
select
  b.name,
  a.folder_id,
  count(*)
from
  tbl_naver_folder_place a
  left join tbl_naver_folder b on a.folder_id = b.folder_id
group by
  b.name,
  a.folder_id
order by
  b.name COLLATE "ko-KP-x-icu" ASC;

-- 폴더별 장소 개수 결과를 tbl_bucket에 upsert
WITH folder_counts AS (
  SELECT
    b.name as folder_name,
    a.folder_id,
    count(*) as place_count
  FROM
    tbl_naver_folder_place a
    LEFT JOIN tbl_naver_folder b ON a.folder_id = b.folder_id
  GROUP BY
    b.name,
    a.folder_id
)
INSERT INTO
  tbl_bucket (
    key,
    name,
    value,
    data,
    data_jsonb,
    created_at,
    updated_at
  )
SELECT
  'naver_folder_list' as key,
  'naver_folder_list' as name,
  NULL as value,
  NULL as data,
  jsonb_agg(
    jsonb_build_object(
      'name',
      folder_name,
      'id',
      folder_id,
      'count',
      place_count
    )
    ORDER BY
      folder_name COLLATE "ko-KP-x-icu" ASC
  ) as data_jsonb,
  now() as created_at,
  now() as updated_at
FROM
  folder_counts ON CONFLICT (key, name) DO
UPDATE
SET
  data_jsonb = EXCLUDED.data_jsonb,
  updated_at = now();

-- 해당 폴더의 장소 데이터 삭제
delete from
  tbl_naver_folder_place
where
  folder_id in (
    select
      folder_id
    from
      tbl_naver_folder
    where
      name like '최자로드%'
  );

-- 해당 폴더 삭제
delete from
  tbl_naver_folder
where
  folder_id in (
    select
      folder_id
    from
      tbl_naver_folder
    where
      name like '최자로드%'
  );
