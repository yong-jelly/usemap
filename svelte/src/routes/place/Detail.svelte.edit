<script lang="ts">
	import { authStore } from '$services/auth.store';
	import { supabasePlaceService } from '$services/supabase';
	import { supabaseCommentService } from '$services/supabase/comment.service';
	import { NaverStaticMapUrlParserAndBuilder } from '$utils/NaverStaticMapUrlParserAndBuilder';
	import type {
		PlaceDetail,
		SupabaseComment,
		AuthUser,
		VoteItem,
		UpdateCommentData,
		ReviewItemForDetail,
		Place as PlaceItem,
	} from '$services/types';
	import {
		structureComments,
		addCommentToList,
		addReplyToList,
		removeCommentFromList,
		toggleLikeInList,
		updateCommentInList,
	} from './comment.logic';
	import CommentSection from './CommentSection.svelte';
	import TagSection from './TagSection.svelte';
	import ReviewCardSimple from './components/ReviewCardSimple.svelte';
	import Indicator from '$lib/components/Indicator.svelte';
	import { goto } from '@mateothegreat/svelte5-router';
	import PlaceHeader from './components/PlaceHeader.svelte';
	import HeaderNavigation from './components/HeaderNavigation.svelte';

	// --- Props & Basic State ---
	const props = $props<{
		placeId?: string;
		onClose?: () => void;
		route?: { result: { path: { params: { id: string } } } };
	}>();

	// ID ê²°ì • ë¡œì§ (props, route, URL ìˆœì„œë¡œ)
	const businessId =
		props.placeId ||
		props.route?.result?.path?.params?.id ||
		window.location.pathname.split('/place/')[1] ||
		'';

	console.log('ì¥ì†Œ ìƒì„¸ í˜ì´ì§€ ë¡œë“œ:', businessId);

	let place: PlaceItem | null = $state(null);
	let loading = $state(true);
	let placeImages: string[] = $state([]);
	let placeVotes: VoteItem[] = $state([]);
	let isBookmarked = $state(false);
	let currentImageIndex = $state(0);
	let activeTab = $state(0);
	let reviewList: ReviewItemForDetail[] = $state([]);
	let expandedReviewIds: Record<string, boolean> = $state({});
	let currentReviewIndex = $state(0);
	let showShareDialog = $state(false);

	// --- Auth State ---
	let currentUser = $state<AuthUser | null>(null);
	$inspect(currentUser);

	// $effect ì‚¬ìš©í•˜ì—¬ authStore êµ¬ë… ë° currentUser ì—…ë°ì´íŠ¸ (ê°œì„ )
	$effect(() => {
		console.log('Auth effect triggered');
		const unsubscribe = authStore.subscribe((storeState) => {
			console.log('Auth store updated:', storeState);
			const nextUser = storeState.isAuthenticated ? storeState : null;
			// ì‹¤ì œ ì‚¬ìš©ì ìƒíƒœ ë³€ê²½ ì‹œì—ë§Œ currentUser ì—…ë°ì´íŠ¸ (ID ë¹„êµ)
			if (currentUser?.id !== nextUser?.id) {
				console.log(`currentUser changing from ${currentUser?.id} to ${nextUser?.id}`);
				currentUser = nextUser;
			} else if (
				currentUser &&
				nextUser &&
				JSON.stringify(currentUser) !== JSON.stringify(nextUser)
			) {
				// IDëŠ” ê°™ì§€ë§Œ ë‹¤ë¥¸ ë©”íƒ€ë°ì´í„° ë“±ì´ ë³€ê²½ëœ ê²½ìš° (í•„ìš”ì‹œ ë” ì •êµí•œ ë¹„êµ ì¶”ê°€)
				console.log('currentUser metadata updated, but ID is the same.');
				currentUser = nextUser;
			} else if (!currentUser && !nextUser) {
				// ë‘˜ ë‹¤ nullì´ë©´ ë³€ê²½ ì—†ìŒ
			} else {
				console.log('currentUser state unchanged.');
			}
		});
		return unsubscribe;
	});

	// --- Comment State ---
	let comments = $state<SupabaseComment[]>([]);
	let commentLoading = $state(true);
	let commentError = $state<string | null>(null);
	let totalComments = $state<number>(0);
	let loadedCommentCount = $state(0);
	let commentLoadingMore = $state(false);
	const commentsPerPage = 20;
	let newCommentContent = $state('');
	let replyingTo = $state<{ commentId: string; username: string } | null>(null);
	let replyContent = $state('');

	// --- Comment Editing State ---
	let editingCommentId = $state<string | null>(null);
	let editContent = $state('');
	let staticMapImage = $state('');

	// --- Data Loading ---
	async function loadPlaceDetail(id: string) {
		try {
			loading = true;
			commentLoading = true;
			console.log('Place detail load start:', id);
			const response = await supabasePlaceService.getPlaceDetail(id);

			loading = false;
			commentLoading = false;

			place = response.result.row as PlaceItem;
			// console.log(place);
			const mapUrl = new NaverStaticMapUrlParserAndBuilder(
				place.static_map_url ?? '',
			);
			staticMapImage = mapUrl.build();
			// console.log('Place detail loaded:', (place as any).normalized_name);
			// ë¦¬ë·° ëª©ë¡
			reviewList = (place as any).reviews;
			if (place) {
				isBookmarked = (place as any).interaction?.is_saved ?? false;
				placeImages = (place as any).images ?? [];
				placeVotes = transformVotes(
					(place as any).voted_summary_text,
					(place as any).voted_summary_code,
				);
				totalComments = (place as any).interaction?.place_comment_count ?? 0;

				// await loadComments(false);
			} else {
				console.error('Place data is null after fetch');
			}
		} catch (error) {
			console.error('Failed to load place details:', error);
			loading = false;
			commentLoading = false;
		}
	}

	function transformVotes(texts: string[] | undefined, codes: string[] | undefined): VoteItem[] {
		if (!texts || !codes || texts.length !== codes.length) {
			return [];
		}
		return texts.map((text, index) => ({
			text: text.replace(/"/g, ''),
			icon_code: codes[index] ?? '',
			count: 1,
		}));
	}

	async function loadComments(loadMore = false) {
		return 0;
		if (commentLoadingMore) return;
		if (!loadMore) {
			commentLoading = true;
			commentError = null;
			loadedCommentCount = 0;
			const { data: countData, error: countError } =
				await supabaseCommentService.getCommentCountForPlace(businessId);
			if (countData !== null && !countError) totalComments = countData;
			else {
				totalComments = 0;
				console.error('Error fetching comment count:', countError);
			}
		} else {
			commentLoadingMore = true;
		}
		const currentOffset = loadedCommentCount;
		const { data: flatCommentList, error: fetchError } =
			await supabaseCommentService.getCommentsForPlace(businessId, commentsPerPage, currentOffset);
		if (fetchError) {
			commentError = 'ëŒ“ê¸€ ì˜¤ë¥˜';
			console.error('Err fetch comments:', fetchError);
			if (!loadMore) comments = [];
		} else if (flatCommentList && flatCommentList.length > 0) {
			loadedCommentCount += flatCommentList.length;
			comments = structureComments(flatCommentList, loadMore ? comments : []);
			commentError = null;
		} else {
			if (!loadMore && comments.length === 0) {
				/* no-op */
			}
		}
		if (!loadMore) commentLoading = false;
		commentLoadingMore = false;
	}

	// --- Comment Handlers ---
	async function handleLoadMoreComments() {
		await loadComments(true);
	}

	async function handleSubmitComment() {
		if (!newCommentContent.trim() || !currentUser) return;
		const commentData = { business_id: businessId, content: newCommentContent.trim() };

		// createCommentForPlace í˜¸ì¶œ ì‹œ currentUser ì „ë‹¬ ì œê±°
		// ë°˜í™˜ê°’ì€ ìƒì„±ëœ ëŒ“ê¸€ ê°ì²´ (newCommentData)
		const { data: newCommentData, error: createError } =
			await supabaseCommentService.createCommentForPlace(commentData);

		if (newCommentData && !createError) {
			// ë°˜í™˜ëœ ê°ì²´ë¥¼ ì§ì ‘ ì‚¬ìš©
			comments = addCommentToList(comments, newCommentData);
			totalComments += 1;
			loadedCommentCount += 1;
			newCommentContent = '';
		} else {
			console.error('Error creating comment:', createError);
			alert('ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨');
		}
	}

	async function handleEditComment(commentId: string) {
		// TODO: ëŒ“ê¸€ ìˆ˜ì • ë¡œì§ êµ¬í˜„
		console.log('Editing comment:', commentId);
	}

	async function handleSubmitReply() {
		if (!replyContent.trim() || !replyingTo || !currentUser) return;
		const replyData = {
			business_id: businessId,
			content: replyContent.trim(),
			parent_comment_id: replyingTo.commentId,
		};

		// createCommentForPlace í˜¸ì¶œ ì‹œ currentUser ì „ë‹¬ ì œê±°
		// ë°˜í™˜ê°’ì€ ìƒì„±ëœ ë‹µê¸€ ê°ì²´ (newReplyData)
		const { data: newReplyData, error: createError } =
			await supabaseCommentService.createCommentForPlace(replyData);

		if (newReplyData && !createError) {
			// ë°˜í™˜ëœ ê°ì²´ë¥¼ ì§ì ‘ ì‚¬ìš©
			const updatedList = addReplyToList(comments, newReplyData);
			if (updatedList) {
				comments = updatedList;
				totalComments += 1;
				loadedCommentCount += 1;
			} else {
				await loadComments(false);
			} // ë¶€ëª¨ ëª» ì°¾ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
			replyContent = '';
			replyingTo = null;
		} else {
			console.error('Error submitting reply:', createError);
			alert('ë‹µê¸€ ì‘ì„± ì‹¤íŒ¨');
		}
	}

	async function handleDeleteComment(commentId: string) {
		if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
		const { data, error } = await supabaseCommentService.deactivateCommentForPlace(commentId);
		if (data && !error) {
			const { result, decreaseCount } = removeCommentFromList(comments, commentId);
			comments = result;
			totalComments -= decreaseCount;
			loadedCommentCount -= decreaseCount;
			if (totalComments < 0) totalComments = 0;
			if (loadedCommentCount < 0) loadedCommentCount = 0;
		} else {
			console.error('Error deactivating comment:', error);
			alert('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨');
		}
	}

	async function handleToggleLike(commentId: string) {
		if (!currentUser) return;
		const { data: isLikedNow, error } =
			await supabaseCommentService.toggleCommentLikeForPlace(commentId);
		if (!error && isLikedNow !== null) {
			comments = toggleLikeInList(comments, commentId, isLikedNow);
		} else {
			console.error('Failed to toggle like:', error);
		}
	}

	// --- New Comment Edit Handlers ---
	function findCommentById(list: SupabaseComment[], id: string): SupabaseComment | null {
		for (const comment of list) {
			if (comment.id === id) return comment;
			if (comment.replies) {
				const foundInReply = findCommentById(comment.replies, id);
				if (foundInReply) return foundInReply;
			}
		}
		return null;
	}

	async function handleStartEdit(commentId: string) {
		console.log('Starting edit for comment:', commentId);
		const commentToEdit = findCommentById(comments, commentId);
		if (commentToEdit && commentToEdit.user_id === currentUser?.id) {
			editingCommentId = commentId;
			editContent = commentToEdit.content ?? ''; // ìˆ˜ì •í•  ë‚´ìš© ì´ˆê¸°í™”
			// Optionally focus the edit input field after a short delay
			setTimeout(() => {
				const editInput = document.getElementById(`edit-input-${commentId}`);
				editInput?.focus();
			}, 50);
		} else {
			// Optional: Show an error message if the user is not the author
			console.warn('Cannot edit comment: Not the author or comment not found.');
			alert('ìì‹ ì´ ì‘ì„±í•œ ëŒ“ê¸€ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
		}
	}

	function handleCancelEdit() {
		editingCommentId = null;
		editContent = '';
	}

	async function handleSubmitEdit() {
		if (!editingCommentId || !editContent.trim()) return;

		try {
			// 1. ì›ë³¸ ëŒ“ê¸€ ì°¾ê¸°
			const originalComment = findCommentById(comments, editingCommentId);
			if (!originalComment) {
				throw new Error('ìˆ˜ì •í•  ëŒ“ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
			}

			// 2. ìˆ˜ì • ë°ì´í„° ì¤€ë¹„
			const commentData: UpdateCommentData = {
				content: editContent.trim(),
			};

			// 3. API í˜¸ì¶œ
			const { data, error } = await supabaseCommentService.updateCommentForPlace(
				editingCommentId,
				commentData,
			);

			if (error) {
				throw new Error(`ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨: ${error.message}`);
			}

			// 4. ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
			// API ì‘ë‹µì— ê´€ê³„ì—†ì´ ì„±ê³µìœ¼ë¡œ ê°€ì •í•˜ê³  ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
			const updatedCommentObj: SupabaseComment = {
				...originalComment,
				content: editContent.trim(),
				updated_at: new Date().toISOString(),
			};

			comments = updateCommentInList(comments, updatedCommentObj);
			handleCancelEdit(); // ìˆ˜ì • ìƒíƒœ ì´ˆê¸°í™”
		} catch (error) {
			console.error('ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜:', error);
			alert('ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
		}
	}

	function handleStartReply(commentId: string, username: string) {
		replyingTo = { commentId, username };
		setTimeout(() => {
			document.getElementById('replyInput')?.focus();
		}, 50);
	}
	function handleCancelReply() {
		replyingTo = null;
		replyContent = '';
	}
	function handleLoginRequest() {
		authStore.login();
	}

	// --- Initial Load & Effects ---
	$effect(() => {
		console.log('Mount effect: Place ID:', businessId);
		if (businessId) {
			loadPlaceDetail(businessId);
		} else {
			loading = false;
			commentLoading = false;
		}
		if (props.onClose && isMobile()) {
			const handlePopState = () => {
				if (props.onClose) props.onClose();
			};
			window.addEventListener('popstate', handlePopState);
			return () => {
				window.removeEventListener('popstate', handlePopState);
			};
		}
	});

	// --- Utility Functions ---
	const categoryColors: Record<string, string> = {
		í•œì‹: 'bg-red-500',
		ì¤‘ì‹: 'bg-yellow-600',
		ì¼ì‹: 'bg-indigo-500',
		ì–‘ì‹: 'bg-green-600',
		ì¹´í˜: 'bg-brown-500',
		ë¶„ì‹: 'bg-orange-500',
		ê³ ê¸°: 'bg-red-600',
		ë¼ì§€ê³ ê¸°êµ¬ì´: 'bg-rose-600',
		ì†Œê³ ê¸°êµ¬ì´: 'bg-red-700',
		ì¹˜í‚¨: 'bg-yellow-500',
		í”¼ì: 'bg-orange-600',
		í•´ì‚°ë¬¼: 'bg-blue-600',
		íŒ¨ìŠ¤íŠ¸í‘¸ë“œ: 'bg-red-500',
		ë””ì €íŠ¸: 'bg-pink-500',
		ë² ì´ì»¤ë¦¬: 'bg-amber-600',
		ì•„ì‹œì•ˆ: 'bg-green-500',
		ê¸°íƒ€: 'bg-gray-500',
	};
	function getCategoryColor(category: string): string {
		if (!category) return 'bg-yellow-500';
		for (const key in categoryColors) {
			if (category.includes(key)) return categoryColors[key];
		}
		return 'bg-yellow-500';
	}
	function handleImageError(event: Event) {
		const imgElement = event.target as HTMLImageElement;
		if (imgElement) imgElement.src = 'https://placehold.co/800x400?text=Image+Not+Found';
		// if (imgElement) imgElement.src = 'https://via.placeholder.com/800x600?text=ë§›ì§‘+ì´ë¯¸ì§€';
	}
	function toggleBookmark() {
		isBookmarked = !isBookmarked; /* TODO: API ì—°ë™ */
	}
	function previousImage() {
		if (placeImages.length <= 1) return;
		currentImageIndex = (currentImageIndex - 1 + placeImages.length) % placeImages.length;
	}
	function nextImage() {
		if (placeImages.length <= 1) return;
		currentImageIndex = (currentImageIndex + 1) % placeImages.length;
	}
	function isMobile() {
		return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
			navigator.userAgent,
		);
	}
	function goBack() {
		console.log('ì¥ì†Œ ìƒì„¸ > ë’¤ë¡œê°€ê¸° ì‹¤í–‰');

		// ë’¤ë¡œê°€ê¸° í”Œë˜ê·¸ ì„¤ì • (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ëŠ” í•„ìˆ˜ì ì¸ ê²½ìš°ë§Œ ì‚¬ìš©)
		sessionStorage.setItem('wasNavigatingBack', 'true');

		// í˜„ì¬ ë³´ë˜ ì»¨í…ì¸  ID ì €ì¥ (sessionStorageë§Œ ì‚¬ìš©)
		if (place && (place as any).id) {
			sessionStorage.setItem('currentViewingContentId', (place as any).id);
		}

		// í™ˆìœ¼ë¡œ ì´ë™ (ìµœì†Œí•œì˜ ìƒíƒœ ì •ë³´ë§Œ í¬í•¨)
		goto('/', {
			state: {
				isBackNavigation: true,
				fromPlaceDetail: true,
				businessId: place ? (place as any).id : undefined,
				timestamp: new Date().getTime(),
			},
		});
	}
	function openExternalUrl(url: string) {
		window.open(url, '_blank');
	}
	function getEmojiFromIconCode(iconCode: string): string {
		const emojiMap: Record<string, string> = {
			face_savoring_food: 'ğŸ˜‹',
			beating_heart: 'â¤ï¸',
			meat_cut: 'ğŸ¥©',
			eyes: 'ğŸ‘€',
			steamed_rice: 'ğŸš',
			sparkles: 'âœ¨',
			cook: 'ğŸ‘¨â€ğŸ³',
			leaf: 'ğŸƒ',
			park_sign: 'ğŸ…¿ï¸',
			fire: 'ğŸ”¥',
			couch_and_lamp: 'ğŸ›‹ï¸',
			coin: 'ğŸ’°',
			bouquet: 'ğŸ’',
			restroom: 'ğŸš»',
			framed_picture: 'ğŸ–¼ï¸',
			rice_ball: 'ğŸ™',
			bento_box: 'ğŸ±',
			green_heart: 'ğŸ’š',
			nose: 'ğŸ‘ƒ',
			baby_face: 'ğŸ‘¶',
			face_smiling: 'ğŸ˜Š',
			stopwatch: 'â±ï¸',
			sun: 'â˜€ï¸',
			gem_stone: 'ğŸ’',
			salad: 'ğŸ¥—',
			wind: 'ğŸ’¨',
			face_relieved: 'ğŸ˜Œ',
			busts_in_silhouette: 'ğŸ‘¥',
		};
		return emojiMap[iconCode] || 'ğŸ½ï¸';
	}

	// ë¦¬ë·° í™•ì¥/ì¶•ì†Œ í† ê¸€ í•¨ìˆ˜
	function toggleReviewExpand(reviewId: string) {
		expandedReviewIds = {
			...expandedReviewIds,
			[reviewId]: !expandedReviewIds[reviewId],
		};
	}

	// ë¦¬ë·° ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
	function handleReviewScroll(event: Event) {
		if (!reviewList.length) return;

		const target = event.target as HTMLElement;
		const scrollLeft = target.scrollLeft;
		const itemWidth = target.scrollWidth / reviewList.length;

		// í˜„ì¬ ë³´ì´ëŠ” ë¦¬ë·° ì¸ë±ìŠ¤ ê³„ì‚°
		const index = Math.round(scrollLeft / itemWidth);
		if (index >= 0 && index < reviewList.length) {
			currentReviewIndex = index;
		}
	}

	// ë’¤ë¡œê°€ê¸° ìŠ¤ì™€ì´í”„ êµ¬í˜„
	let startX: number;
	let startTime: number;

	function handleTouchStart(e: TouchEvent): void {
		startX = e.touches[0].clientX;
		startTime = new Date().getTime();
	}

	function handleTouchEnd(e: TouchEvent): void {
		const endX = e.changedTouches[0].clientX;
		const endTime = new Date().getTime();
		const diffX = endX - startX;
		const diffTime = endTime - startTime;

		// ì™¼ìª½ ê°€ì¥ìë¦¬ì—ì„œ ì‹œì‘í•´ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„í•˜ëŠ” ê²½ìš° (ë’¤ë¡œê°€ê¸°)
		if (startX < 50 && diffX > 100 && diffTime < 300) {
			console.log('ìŠ¤ì™€ì´í”„ë¡œ ë’¤ë¡œê°€ê¸° ê°ì§€');
			goBack();
		}
	}

	// ìŠ¤í¬ë¡¤ ë°©í–¥ ê°ì§€ í•¨ìˆ˜
	let lastScrollTop = 0;
	let scrollPosition = $state(0);
	let scrollDirection = $state('');
	let showHeader = $state(true);

	function handleScroll() {
		const st = window.pageYOffset || document.documentElement.scrollTop;

		if (st > lastScrollTop && st > 50) {
			// ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
			scrollDirection = 'down';
			showHeader = false;
		} else {
			// ìœ„ë¡œ ìŠ¤í¬ë¡¤
			scrollDirection = 'up';
			showHeader = true;
		}

		lastScrollTop = st <= 0 ? 0 : st;
		scrollPosition = st;
	}

	// popstate ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë‹ (ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ëˆŒë €ì„ ë•Œ)
	$effect(() => {
		const handlePopState = (event: PopStateEvent) => {
			console.log('ì¥ì†Œ ìƒì„¸ > popstate ì´ë²¤íŠ¸ ë°œìƒ');

			// ë¸Œë¼ìš°ì € ê¸°ë³¸ ë’¤ë¡œê°€ê¸° ë™ì‘ì„ ë°©í•´í•˜ì§€ ì•ŠìŒ
			// preventDefault()ë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ

			// ì¤‘ìš”: ê¸°ë³¸ ë’¤ë¡œê°€ê¸° ë™ì‘ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì²˜ë¦¬ë˜ë„ë¡ í•¨
			// ì¶”ê°€ ì‘ì—…ì€ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ìµœì†Œí•œìœ¼ë¡œ ìˆ˜í–‰

			// ì„¸ì…˜ì— ê°„ë‹¨í•œ í”Œë˜ê·¸ë§Œ ì„¤ì • (localStorage ì‚¬ìš© ìµœì†Œí™”)
			try {
				sessionStorage.setItem('wasNavigatingBack', 'true');
				if (place && (place as any).id) {
					sessionStorage.setItem('currentViewingContentId', (place as any).id);
				}
			} catch (e) {
				console.error('ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì ‘ê·¼ ì˜¤ë¥˜:', e);
			}

			// ì´ í•¨ìˆ˜ëŠ” ë¸Œë¼ìš°ì €ì˜ ê¸°ë³¸ ë’¤ë¡œê°€ê¸°ë¥¼ ë°©í•´í•˜ì§€ ì•Šê³  í•„ìš”í•œ í”Œë˜ê·¸ë§Œ ì„¤ì •
		};

		window.addEventListener('popstate', handlePopState);

		return () => {
			window.removeEventListener('popstate', handlePopState);
		};
	});

	// ì–¸ë¡œë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë‹ (í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ)
	$effect(() => {
		const handleBeforeUnload = () => {
			console.log('í˜ì´ì§€ ì–¸ë¡œë“œ ì¤‘');
			// í˜ì´ì§€ ì´íƒˆ ì‹œ ë’¤ë¡œê°€ê¸° í”Œë˜ê·¸ ì„¤ì •
			// localStorageëŠ” ê¼­ í•„ìš”í•œ ê²½ìš°ë§Œ ì‚¬ìš©
			try {
				sessionStorage.setItem('wasNavigatingBack', 'true');
			} catch (e) {
				console.error('ì–¸ë¡œë“œ ì¤‘ í”Œë˜ê·¸ ì„¤ì • ì˜¤ë¥˜:', e);
			}
		};

		window.addEventListener('beforeunload', handleBeforeUnload);

		return () => {
			window.removeEventListener('beforeunload', handleBeforeUnload);
		};
	});

	$effect(() => {
		console.log('ìƒì„¸ í˜ì´ì§€ ì´í™íŠ¸ ì‹¤í–‰');

		// ë°ì´í„° ë¡œë“œ
		loadPlaceDetail(businessId);

		// í„°ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
		document.addEventListener('touchstart', handleTouchStart);
		document.addEventListener('touchend', handleTouchEnd);

		// ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
		window.addEventListener('scroll', handleScroll);

		// History APIë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒíƒœ ì €ì¥ - í•„ìš”í•œ ë°ì´í„°ë§Œ ìµœì†Œí™”
		try {
			// URL ë³€ê²½ ì—†ì´ íˆìŠ¤í† ë¦¬ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸
			const state = {
				fromPlaceDetail: true,
				businessId: businessId,
				savedAt: new Date().getTime(),
			};

			history.replaceState(state, '', window.location.href);
			console.log('ìƒì„¸ í˜ì´ì§€ ìƒíƒœ ì €ì¥ ì™„ë£Œ');
		} catch (e) {
			console.error('íˆìŠ¤í† ë¦¬ ìƒíƒœ ì €ì¥ ì˜¤ë¥˜:', e);
		}

		return () => {
			document.removeEventListener('touchstart', handleTouchStart);
			document.removeEventListener('touchend', handleTouchEnd);
			window.removeEventListener('scroll', handleScroll);
		};
	});
</script>

<!-- Template -->
<div
	class="fixed inset-0 z-50 overflow-auto bg-white"
	ontouchstart={handleTouchStart}
	ontouchend={handleTouchEnd} style="padding-top: env(safe-area-inset-top);"
>
	<!-- HeaderNavigation: ì´ì œ ì—¬ê¸°ì— ë°°ì¹˜ -->
	<div class="sticky 
	flex items-center top-0 left-0 right-0  h-16 mx-auto max-w-2xl p-0 
	top-0 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-200" >
		<HeaderNavigation 
			onBack={goBack} 
			onShare={() => { showShareDialog = true; }} 
			onSearch={() => { alert('ê²€ìƒ‰ ê¸°ëŠ¥ êµ¬í˜„ í•„ìš”'); }}
		/>
	</div>

	<!-- ìƒˆë¡œìš´ PlaceHeader ì»´í¬ë„ŒíŠ¸ (ë„¤ë¹„ê²Œì´ì…˜ ì—†ìŒ) -->
	{#if place}
		{@const placeData = place as any}
		{@const bgImage = placeImages && placeImages.length > 0 ? placeImages[0] : undefined}
		{@const posterImage = placeData?.thum_url || bgImage}
		{@const conveniencesList = placeData?.conveniences || [
			'ë‹¨ì²´ ì´ìš© ê°€ëŠ¥', 'í¬ì¥', 'ë°˜ë ¤ë™ë¬¼ ë™ë°˜', 'ë‚¨/ë…€ í™”ì¥ì‹¤ êµ¬ë¶„', 
			'ìœ ì•„ì˜ì', 'ê°„í¸ê²°ì œ', 'ì£¼ì°¨'
		]}
		{@const websiteUrl = placeData?.homepage || []}
		{@const galleryImages = placeImages?.slice(1) ?? []}
		{@const url = placeData?.id ? `https://map.naver.com/p/entry/place/${placeData.id}` : undefined}

		<PlaceHeader
			title={placeData?.name ?? 'ì¥ì†Œ ì •ë³´'}
			subtitle={placeData?.category ?? 'ì¹´í…Œê³ ë¦¬'}
			visitorReviewCount={placeData?.visitor_reviews_total ?? 3487}
			rating={placeData?.visitor_reviews_score ?? 4.4}
			commonAddress={placeData?.address}
			roadAddress={placeData?.road_address}
			naverPlaceId={placeData?.naver_place_id}
			website={websiteUrl}
			conveniences={conveniencesList}
			posterImageUrl={posterImage}
			galleryImageUrls={galleryImages}
			url={url}
			onBack={goBack} 
			onShare={() => { showShareDialog = true; }} 
			onSearch={() => { console.log('ê²€ìƒ‰ ê¸°ëŠ¥ êµ¬í˜„ í•„ìš”'); }}
			onShowGallery={() => { console.log('ê°¤ëŸ¬ë¦¬ ë³´ê¸° ê¸°ëŠ¥ êµ¬í˜„ í•„ìš”'); }}
		/>
	{/if}

	

	<!-- ê¸°ì¡´ ì»¨í…ì¸  (í—¤ë” ì•„ë˜ì— í‘œì‹œë  ìˆ˜ ìˆë„ë¡ ìƒë‹¨ ì—¬ë°± ì¶”ê°€) -->

	<!-- <div class="mx-auto max-w-lg"> -->
	<div class="relative w-full mx-auto max-w-2xl text-gray-800 bg-white mb-4" style="padding-top: env(safe-area-inset-top);">	
		{#if loading}
			<!-- <div class="flex justify-center p-16">
						<div class="h-16 w-16 animate-spin rounded-full border-t-4 border-b-4 border-blue-500"></div>
					</div> -->
			<Indicator text="ìŒì‹ì  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..." />
		{:else if !place}
			<div class="p-8 text-center">
				<svg
					class="mx-auto mb-4 h-16 w-16 text-gray-400"
					fill="none"
					stroke="currentColor"
					viewBox="0 0 24 24"
				>
					<path
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="2"
						d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
					></path>
				</svg>
				<p class="text-lg text-gray-500">ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
				<button
					class="mt-4 rounded-full bg-blue-500 px-6 py-2 text-white shadow-sm transition-colors hover:bg-blue-600"
					onclick={goBack}
				>
					ëŒì•„ê°€ê¸°
				</button>
			</div>
		{:else}
			<!-- {#if placeImages && placeImages.length > 0}
				<div class="relative h-80 w-full overflow-hidden">
					<img
						src={placeImages[currentImageIndex]}
						alt={place ? ((place as any).normalized_name ?? 'ì¥ì†Œ ì´ë¯¸ì§€') : 'ì¥ì†Œ ì´ë¯¸ì§€'}
						class="h-full w-full object-cover transition-transform duration-300 hover:scale-105"
						onerror={handleImageError}
					/>
					{#if placeImages.length > 1}
						<div
							class="absolute right-4 bottom-4 rounded-full bg-black/60 px-3 py-1.5 text-xs font-medium text-white backdrop-blur-sm"
						>
							{currentImageIndex + 1} / {placeImages.length}
						</div>
						<button
							class="absolute top-1/2 left-2 flex h-10 w-10 -translate-y-1/2 transform items-center justify-center rounded-full bg-black/40 text-white backdrop-blur-sm transition-all hover:bg-black/60"
							onclick={previousImage}
							aria-label="ì´ì „ ì´ë¯¸ì§€"
						>
							<svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M15 19l-7-7 7-7"
								></path>
							</svg>
						</button>
						<button
							class="absolute top-1/2 right-2 flex h-10 w-10 -translate-y-1/2 transform items-center justify-center rounded-full bg-black/40 text-white backdrop-blur-sm transition-all hover:bg-black/60"
							onclick={nextImage}
							aria-label="ë‹¤ìŒ ì´ë¯¸ì§€"
						>
							<svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M9 5l7 7-7 7"
								></path>
							</svg>
						</button>
					{/if}
				</div>
			{/if} -->
			<!-- ê¸°ë³¸ ì •ë³´ -->
			<div class="p-6">
				<!-- <div class="mb-3 flex items-start justify-between">
					<div>
						<h1 class="text-2xl font-bold text-gray-900">{(place as any)?.normalized_name}</h1>
					</div>
					{#if (place as any)?.url}<a
							href={(place as any).url}
							target="_blank"
							rel="noopener noreferrer"
							class="flex items-center gap-1.5 rounded-full bg-gray-50 px-3 py-1.5 text-gray-600 transition-colors hover:bg-gray-100"
							aria-label="ë„¤ì´ë²„ ì¥ì†Œ ë³´ê¸°"
						>
							<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
								></path>
							</svg>
							<span class="text-sm font-medium">ë„¤ì´ë²„ ì§€ë„</span>
						</a>{/if}
				</div> -->
				<!-- ì¹´í…Œê³ ë¦¬ íƒœê·¸ ì¶”ê°€ -->
				<!-- {#if place.category}
							<div class="mb-3">
								<span class="inline-block rounded-full {getCategoryColor(place.category)} px-3 py-1 text-xs font-medium text-white">
									{place.category}
								</span>
							</div>
						{/if} -->
				<!-- {#if (place as any)?.road_address}<div class="mb-4 flex items-start gap-3">
						<svg
							class="mt-0.5 h-5 w-5 shrink-0 text-gray-500"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
							/>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
							/>
						</svg>
						<div>
							<p class="text-sm text-gray-700">{(place as any)?.common_address}</p>
							<p class="text-xs text-gray-500">{(place as any)?.road_address}</p>
							<button
								class="mt-1 flex items-center gap-1 text-xs text-blue-600 transition-colors hover:text-blue-800"
								onclick={() => {
									if (navigator.clipboard && place) {
										navigator.clipboard.writeText((place as any).road_address);
										alert('ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
									}
								}}
							>
								<svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"
									></path>
								</svg>
								ì£¼ì†Œ ë³µì‚¬
							</button>
						</div>
					</div>{/if} -->
			</div>

			<!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
			<div class="sticky top-0 z-10 border-t border-gray-50">
				<div class="flex">
					<button
						class="flex-1 px-4 py-3 text-center font-medium transition-colors {activeTab === 0
							? 'border-b-2 border-blue-600 text-blue-600'
							: 'text-gray-600 hover:bg-gray-50'}"
						onclick={() => (activeTab = 0)}
					>
						ì •ë³´
					</button>
					<button
						class="flex-1 px-4 py-3 text-center font-medium transition-colors {activeTab === 1
							? 'border-b-2 border-blue-600 text-blue-600'
							: 'text-gray-600 hover:bg-gray-50'}"
						onclick={() => (activeTab = 1)}
					>
						ë°©ë¬¸ì í‰ê°€
					</button>
					<button
						class="flex-1 px-4 py-3 text-center font-medium transition-colors {activeTab === 2
							? 'border-b-2 border-blue-600 text-blue-600'
							: 'text-gray-600 hover:bg-gray-50'}"
						onclick={() => (activeTab = 2)}
					>
						íƒœê·¸
					</button>
					<button
						class="flex-1 px-4 py-3 text-center font-medium transition-colors {activeTab === 3
							? 'border-b-2 border-blue-600 text-blue-600'
							: 'text-gray-600 hover:bg-gray-50'}"
						onclick={() => (activeTab = 3)}
					>
						ëŒ“ê¸€ <span
							class="ml-1 rounded-full bg-blue-100 px-1.5 py-0.5 text-xs font-medium text-blue-600"
						>
							{totalComments}
						</span>
					</button>
				</div>
			</div>
			<!-- íƒ­ ì½˜í…ì¸  -->
			{#if activeTab === 0}
				<div class="p-6">
					<div class="mb-6">
						<div class="grid grid-cols-3 gap-3 rounded-xl bg-blue-50/60 p-5 shadow-sm">
							<!-- <div class="flex flex-col items-center">
										<span class="text-xs text-gray-500 mb-1">ì¹´í…Œê³ ë¦¬</span>
										<span class="text-base font-bold text-gray-800">
											{place.category || '-'}
										</span>
									</div> -->
							<div class="flex flex-col items-center">
								<span class="mb-1 text-xs text-gray-500">ë°©ë¬¸ì ë¦¬ë·°</span>
								<span class="text-base font-bold text-gray-800">
									{(place as any)?.visitor_review_count?.toLocaleString() ?? '-'}
								</span>
							</div>
							<div class="flex flex-col items-center">
								<span class="mb-1 text-xs text-gray-500">ë¸”ë¡œê·¸ ë¦¬ë·°</span>
								<span class="text-base font-bold text-gray-800">
									{(place as any)?.blog_cafe_review_count?.toLocaleString() ?? '-'}
								</span>
							</div>
							<div class="flex flex-col items-center">
								<span class="mb-1 text-xs text-gray-500">í‰ì </span>
								<div class="flex items-center">
									<span class="text-base font-bold text-gray-800">
										{(place as any)?.visitor_review_score?.toFixed(1) ?? '-'}
									</span>
									<span class="ml-1 text-yellow-500">â˜…</span>
								</div>
							</div>
						</div>
					</div>

					<!-- ë¦¬ë·° ìŠ¬ë¼ì´ë” ì„¹ì…˜ ê°œì„  -->
					{#if reviewList && reviewList.length > 0}
						<div class="mb-6">
							<h2 class="mb-3 flex items-center gap-2 text-lg font-bold">
								ë°©ë¬¸ì ë¦¬ë·°
								<span
									class="rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800"
								>
									ë„¤ì´ë²„ ë¦¬ë·°
								</span>
							</h2>
							<div
								class="scrollbar-none -mx-6 touch-pan-x overflow-x-auto"
								style="scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; scroll-behavior: smooth;"
								onscroll={handleReviewScroll}
							>
								<div class="flex px-3 pt-1 pb-2">
									{#each reviewList as review, index}
										<div
											style="scroll-snap-align: center; width: 92vw; max-width: 450px;"
											class="shrink-0 px-1.5 py-0.5"
										>
											<ReviewCardSimple
												{review}
												isExpanded={expandedReviewIds[review.id] || false}
												onToggleExpand={() => toggleReviewExpand(review.id)}
												formatDate={(dateString) => {
													if (!dateString || dateString.length !== 8) return '';
													const year = dateString.substring(0, 4);
													const month = dateString.substring(4, 6);
													const day = dateString.substring(6, 8);
													return `${year}.${month}.${day}`;
												}}
											/>
										</div>
									{/each}
								</div>
							</div>

							<!-- í˜ì´ì§€ ì¸ë””ì¼€ì´í„° ì¶”ê°€ -->
							<!-- {#if reviewList.length > 1}
										<div class="mt-3 flex justify-center items-center space-x-2">
											{#each reviewList as _, i}
												<button 
													class="h-2 w-6 rounded-full {i === currentReviewIndex ? 'bg-blue-500' : 'bg-gray-200'} transition-all duration-300"
													aria-label={`ë¦¬ë·° ${i + 1}`}
													onclick={() => {
														const scrollContainer = document.querySelector('.overflow-x-auto') as HTMLElement;
														if (scrollContainer) {
															const itemWidth = scrollContainer.scrollWidth / reviewList.length;
															scrollContainer.scrollTo({
																left: i * itemWidth,
																behavior: 'smooth'
															});
															currentReviewIndex = i;
														}
													}}
												></button>
											{/each}
										</div>
									{/if} -->
						</div>
					{/if}

					{#if (place as any)?.description}<div class="mb-6">
							<h2 class="mb-3 text-lg font-bold">ì„¤ëª…</h2>
							<p
								class="rounded-lg bg-gray-50 p-4 text-sm leading-relaxed whitespace-pre-line text-gray-700"
							>
								{(place as any).description}
							</p>
						</div>{/if}
					{#if (place as any)?.website && (place as any)?.website.length > 0}<div class="mb-6">
							<h2 class="mb-3 text-lg font-bold">ì›¹ì‚¬ì´íŠ¸</h2>
							<div class="flex flex-wrap gap-2">
								{#each (place as any).website as site}<a
										href={site}
										target="_blank"
										rel="noopener noreferrer"
										class="flex items-center gap-1.5 rounded-full bg-gray-100 px-3.5 py-1.5 text-sm text-gray-800 transition-colors hover:bg-gray-200"
									>
										<svg
											class="h-4 w-4 text-blue-600"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
											></path>
										</svg>
										<span class="max-w-[200px] truncate">{new URL(site).hostname}</span>
									</a>{/each}
							</div>
						</div>{/if}
					{#if (place as any)?.convenience && (place as any)?.convenience.length > 0}<div
							class="mb-6"
						>
							<h2 class="mb-3 text-lg font-bold">í¸ì˜ ì‹œì„¤</h2>
							<div class="grid grid-cols-2 gap-3">
								{#each (place as any).convenience as item}<div
										class="flex items-center gap-2.5 rounded-lg bg-gray-50 p-3 transition-colors hover:bg-gray-100"
									>
										<svg
											class="h-5 w-5 text-green-500"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M5 13l4 4L19 7"
											></path>
										</svg>
										<span class="text-sm font-medium text-gray-800">{item}</span>
									</div>{/each}
							</div>
						</div>{/if}

					<!-- ë„¤ì´ë²„ ì§€ë„ ì—°ê²° ë²„íŠ¼ ì¶”ê°€ -->
					{#if (place as any)?.id}
						<div class="mt-8">
							<a
								href={`https://map.naver.com/p/entry/place/${(place as any).id}`}
								target="_blank"
								rel="noopener noreferrer"
								class="flex w-full items-center justify-center gap-2 rounded-xl bg-green-600 py-3 text-center text-white shadow-sm transition-colors hover:bg-green-700"
							>
								<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
									></path>
								</svg>
								ë„¤ì´ë²„ ì§€ë„ì—ì„œ ìì„¸íˆ ë³´ê¸°
							</a>
						</div>
					{/if}
				</div>
			{:else if activeTab === 1}
				{#if placeVotes && placeVotes.length > 0}
					<div class="p-6">
						<div class="grid grid-cols-2 gap-3">
							{#each placeVotes.slice(0, 10) as vote}<div
									class="flex items-center gap-3 rounded-lg border border-transparent bg-gray-50 p-3.5 transition-all hover:border-gray-200 hover:bg-white hover:shadow-sm"
								>
									<div class="shrink-0 rounded-full bg-blue-100 p-2.5 shadow-sm">
										<span class="text-xl">{getEmojiFromIconCode(vote.icon_code)}</span>
									</div>
									<div>
										<p class="text-sm font-medium">{vote.text}</p>
										<p class="text-xs text-gray-500">{vote.count.toLocaleString()}ëª…</p>
									</div>
								</div>{/each}
						</div>
						{#if placeVotes.length > 10}<div class="mt-5 text-center">
								<span
									class="inline-block rounded-full bg-gray-100 px-4 py-1.5 text-sm text-gray-500"
								>
									ì™¸ {placeVotes.length - 10}ê°œ í‰ê°€
								</span>
							</div>{/if}
					</div>
				{:else}
					<div class="p-12 text-center">
						<svg
							class="mx-auto mb-3 h-12 w-12 text-gray-400"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
							></path>
						</svg>
						<p class="text-gray-500">ë“±ë¡ëœ ë°©ë¬¸ì í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
						<p class="mt-1 text-sm text-gray-400">ì²« ë°©ë¬¸ì í‰ê°€ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
					</div>
				{/if}
			{:else if activeTab === 2}
				<TagSection placeId={businessId} />
			{:else if activeTab === 3}
				{#key businessId}
					<CommentSection
						bind:comments
						{currentUser}
						{totalComments}
						loading={commentLoading}
						error={commentError}
						loadingMore={commentLoadingMore}
						bind:replyingTo
						bind:newCommentContent
						bind:replyContent
						onLoadMore={handleLoadMoreComments}
						onSubmitComment={handleSubmitComment}
						onSubmitReply={handleSubmitReply}
						onDeleteComment={handleDeleteComment}
						onToggleLike={handleToggleLike}
						onStartReply={handleStartReply}
						onCancelReply={handleCancelReply}
						onLoginRequest={handleLoginRequest}
						{editingCommentId}
						bind:editContent
						onStartEdit={handleStartEdit}
						onCancelEdit={handleCancelEdit}
						onSubmitEdit={handleSubmitEdit}
					/>
				{/key}
			{/if}
		{/if}
	</div>
</div>
